<!-- templates/index.html -->
{% extends "layout.html" %}
{% block title %}Inventory - Grocery Tracker{% endblock %}
{% block content %}
<div class="container mx-auto p-4 sm:p-6 lg:p-8">
    <!-- Toast Messages -->
    {% with messages = get_flashed_messages(with_categories=true) %}
    {% if messages %}
    <div id="toast-container" class="fixed bottom-5 left-5 z-50">
        {% for category, message in messages %}
        <div
            class="toast-message bg-{{ {'danger': 'red', 'success': 'green', 'info': 'blue'}[category] }}-500 text-white font-bold rounded-lg shadow-md p-4 mb-2 flex items-center justify-between animate-fade-in-up">
            <span>{{ message }}</span>
            <button onclick="this.parentElement.remove();" class="ml-4 text-xl font-semibold">&times;</button>
        </div>
        {% endfor %}
    </div>
    {% endif %}
    {% endwith %}

    <!-- Responsive Header -->
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6">
        <div>
            <h1 class="text-3xl font-bold text-gray-900 dark:text-white mb-2 sm:mb-0">Grocery Inventory</h1>
            <div class="flex items-center mt-2">
                <label for="householdSwitcher" class="text-sm text-gray-600 dark:text-gray-400 mr-2">Household:</label>
                <select id="householdSwitcher"
                    class="text-sm bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-gray-900 dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500">
                    {% for hh in user_households %}
                    <option value="{{ hh.id }}" {% if hh.id==household_id %}selected{% endif %}>{{ hh.name }} ({{
                        hh.household_code }})</option>
                    {% endfor %}
                </select>
            </div>
        </div>
        <!-- Optimized Button Group -->
        <div class="w-full sm:w-auto flex items-center space-x-2 mt-4 sm:mt-0">
            <!-- Desktop Buttons -->
            <div class="hidden sm:flex items-center space-x-2">
                <a href="{{ url_for('add_item', household_id=household_id) }}"
                    class="text-center bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">
                    <i class="fas fa-plus mr-2"></i>Add Item
                </a>
                <a href="{{ url_for('shopping_list', household_id=household_id) }}"
                    class="text-center bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300">
                    <i class="fas fa-shopping-cart mr-2"></i>Shopping List
                </a>
                <div class="relative inline-block text-left">
                    <div>
                        <button type="button" id="menu-button"
                            class="inline-flex justify-center w-full rounded-md border border-gray-300 dark:border-gray-600 shadow-sm px-4 py-2 bg-white dark:bg-gray-700 text-sm font-medium text-gray-700 dark:text-gray-200 hover:bg-gray-50 dark:hover:bg-gray-600 focus:outline-none">
                            More
                            <i class="fas fa-chevron-down -mr-1 ml-2 h-5 w-5"></i>
                        </button>
                    </div>
                    <div id="dropdown-menu"
                        class="origin-top-right absolute right-0 mt-2 w-56 rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-20"
                        role="menu">
                        <div class="py-1" role="none">
                            <a href="{{ url_for('dashboard', household_id=household_id) }}"
                                class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700"
                                role="menuitem"><i class="fas fa-chart-line w-5 mr-2"></i>Dashboard</a>
                            <a href="{{ url_for('pantry', household_id=household_id) }}"
                                class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700"
                                role="menuitem"><i class="fas fa-clipboard-list w-5 mr-2"></i>Master Pantry</a>
                            <a href="{{ url_for('households') }}"
                                class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700"
                                role="menuitem"><i class="fas fa-home w-5 mr-2"></i>Manage Households</a>
                            <a href="{{ url_for('logout') }}"
                                class="text-red-700 dark:text-red-400 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700"
                                role="menuitem"><i class="fas fa-sign-out-alt w-5 mr-2"></i>Logout</a>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Mobile Buttons -->
            <div class="sm:hidden w-full flex flex-col space-y-2">
                <a href="{{ url_for('add_item', household_id=household_id) }}"
                    class="text-center bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-blue-700 transition duration-300">Add
                    Item</a>
                <a href="{{ url_for('shopping_list', household_id=household_id) }}"
                    class="text-center bg-green-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-green-700 transition duration-300">Shopping
                    List</a>
                <div class="relative">
                    <button type="button" id="mobile-menu-button"
                        class="w-full text-center bg-gray-600 text-white font-semibold py-2 px-4 rounded-lg shadow-md hover:bg-gray-700 transition duration-300">
                        More Options <i class="fas fa-bars ml-2"></i>
                    </button>
                    <div id="mobile-menu"
                        class="absolute right-0 mt-2 w-full rounded-md shadow-lg bg-white dark:bg-gray-800 ring-1 ring-black ring-opacity-5 focus:outline-none hidden z-20">
                        <div class="py-1">
                            <a href="{{ url_for('dashboard', household_id=household_id) }}"
                                class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">Dashboard</a>
                            <a href="{{ url_for('pantry', household_id=household_id) }}"
                                class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">Master
                                Pantry</a>
                            <a href="{{ url_for('households') }}"
                                class="text-gray-700 dark:text-gray-200 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">Manage
                                Households</a>
                            <a href="{{ url_for('logout') }}"
                                class="text-red-700 dark:text-red-400 block px-4 py-2 text-sm hover:bg-gray-100 dark:hover:bg-gray-700">Logout</a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Search Form -->
    <div class="mb-6 max-w-md">
        <form action="{{ url_for('view_household', household_id=household_id) }}" method="get" class="relative">
            <div class="absolute inset-y-0 left-0 pl-3 flex items-center pointer-events-none">
                <i class="fas fa-search text-gray-400"></i>
            </div>
            <input type="search" name="search" id="searchInput" value="{{ search_query or '' }}"
                placeholder="Search for an item..."
                class="block w-full pl-10 pr-3 py-2 border border-gray-300 dark:border-gray-600 rounded-lg leading-5 bg-white dark:bg-gray-800 text-gray-900 dark:text-gray-200 placeholder-gray-500 dark:placeholder-gray-400 focus:outline-none focus:placeholder-gray-400 focus:ring-1 focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
        </form>
    </div>

    <!-- Desktop Table View -->
    <div class="hidden sm:block bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-x-auto">
        <table class="min-w-full divide-y divide-gray-200 dark:divide-gray-700">
            <thead class="bg-gray-100 dark:bg-gray-700">
                <tr>
                    <th
                        class="px-6 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                        Item</th>
                    <th
                        class="px-6 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                        Quantity</th>
                    <th
                        class="px-6 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                        Unit</th>
                    <th
                        class="px-6 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                        Status</th>
                    <th
                        class="px-6 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                        Essential</th>
                    <th
                        class="px-6 py-3 text-left text-xs font-bold text-gray-600 dark:text-gray-300 uppercase tracking-wider">
                        Actions</th>
                </tr>
            </thead>
            <tbody id="desktop-item-list"
                class="bg-white dark:bg-gray-800 divide-y divide-gray-200 dark:divide-gray-700">
                {% for item in items %}
                <tr class="grocery-item hover:bg-gray-50 dark:hover:bg-gray-700 transition duration-150">
                    <td class="item-name px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900 dark:text-white">
                        <i class="{{ item.icon_class or 'fas fa-cube' }} w-5 mr-3 text-gray-400 dark:text-gray-500"></i>
                        {{ item.name }}
                    </td>
                    <td class="px-6 py-4">
                        <input type="number" value="{{ item.quantity }}" step="0.01"
                            onchange="updateItem({{ item.id }}, 'quantity', this.value)"
                            class="w-24 px-2 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-gray-900 dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                    </td>
                    <td class="px-6 py-4">
                        <select onchange="updateItem({{ item.id }}, 'quantity_unit', this.value)"
                            class="w-28 px-2 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-gray-900 dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            {% for unit in units %}<option {% if unit==item.quantity_unit %}selected{% endif %}>{{ unit
                                }}</option>{% endfor %}
                        </select>
                    </td>
                    <td class="px-6 py-4">
                        <select onchange="updateItem({{ item.id }}, 'status', this.value)"
                            class="w-36 px-2 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md shadow-sm text-gray-900 dark:text-white focus:outline-none focus:ring-blue-500 focus:border-blue-500 sm:text-sm">
                            {% for status in statuses %}<option {% if status==item.status %}selected{% endif %}>{{
                                status }}</option>{% endfor %}
                        </select>
                    </td>
                    <td class="px-6 py-4 text-center">
                        <input type="checkbox" onchange="updateItem({{ item.id }}, 'is_essential', this.checked)"
                            class="h-5 w-5 text-blue-600 border-gray-300 dark:border-gray-600 rounded focus:ring-blue-500"
                            {% if item.is_essential %}checked{% endif %}>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium">
                        <a href="{{ url_for('edit_item', household_id=household_id, item_id=item.id) }}"
                            class="text-indigo-600 hover:text-indigo-900 dark:text-indigo-400 dark:hover:text-indigo-300 mr-3"
                            title="Edit Full Details"><i class="fas fa-edit"></i></a>
                        <a href="{{ url_for('delete_item', household_id=household_id, item_id=item.id) }}"
                            class="text-red-600 hover:text-red-900 dark:text-red-400 dark:hover:text-red-300"
                            onclick="return confirm('Are you sure you want to delete this item?');"
                            title="Delete Item"><i class="fas fa-trash"></i></a>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="6" class="text-center py-10 text-gray-500 dark:text-gray-400">No grocery items found.
                    </td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    <!-- Mobile Collapsible View -->
    <div id="mobile-item-list" class="block sm:hidden space-y-3">
        {% if grouped_items %}
        {% for category, items_in_category in grouped_items.items() %}
        <div class="accordion-container bg-white dark:bg-gray-800 rounded-xl shadow-lg overflow-hidden">
            <button
                class="accordion-header w-full flex justify-between items-center p-4 text-left font-bold text-gray-800 dark:text-white bg-gray-50 dark:bg-gray-700 hover:bg-gray-100 dark:hover:bg-gray-600 focus:outline-none border-b border-gray-200 dark:border-gray-600">
                <span class="category-name">{{ category }}</span>
                <div class="flex items-center">
                    <span
                        class="item-count mr-2 px-2 py-0.5 bg-blue-100 text-blue-800 dark:bg-blue-900 dark:text-blue-300 text-xs font-semibold rounded-full">{{
                        items_in_category|length }}</span>
                    <i class="fas fa-chevron-down accordion-icon transition-transform duration-300"></i>
                </div>
            </button>
            <div class="accordion-content hidden">
                <div class="p-4 space-y-4">
                    {% for item in items_in_category %}
                    <div
                        class="grocery-item border-t border-gray-200 dark:border-gray-700 pt-4 first:border-t-0 first:pt-0">
                        <div class="flex justify-between items-start">
                            <div>
                                <p class="item-name text-lg font-bold text-gray-900 dark:text-white">{{ item.name }}</p>
                                <p class="text-sm text-gray-500 dark:text-gray-400">{{ item.type }}</p>
                            </div>
                            <div class="flex space-x-4 text-lg">
                                <a href="{{ url_for('edit_item', household_id=household_id, item_id=item.id) }}"
                                    class="text-indigo-600 dark:text-indigo-400"><i class="fas fa-edit"></i></a>
                                <a href="{{ url_for('delete_item', household_id=household_id, item_id=item.id) }}"
                                    class="text-red-600 dark:text-red-400"
                                    onclick="return confirm('Are you sure you want to delete this item?');"><i
                                        class="fas fa-trash"></i></a>
                            </div>
                        </div>
                        <div class="mt-4 grid grid-cols-2 gap-4 text-sm">
                            <div>
                                <label class="font-semibold text-gray-600 dark:text-gray-300">Quantity</label>
                                <input type="number" value="{{ item.quantity }}" step="0.01"
                                    onchange="updateItem({{ item.id }}, 'quantity', this.value)"
                                    class="mt-1 w-full px-2 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                            </div>
                            <div>
                                <label class="font-semibold text-gray-600 dark:text-gray-300">Unit</label>
                                <select onchange="updateItem({{ item.id }}, 'quantity_unit', this.value)"
                                    class="mt-1 w-full px-2 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                                    {% for unit in units %}<option {% if unit==item.quantity_unit %}selected{% endif %}>
                                        {{ unit }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-span-2">
                                <label class="font-semibold text-gray-600 dark:text-gray-300">Status</label>
                                <select onchange="updateItem({{ item.id }}, 'status', this.value)"
                                    class="mt-1 w-full px-2 py-1 bg-white dark:bg-gray-700 border border-gray-300 dark:border-gray-600 rounded-md">
                                    {% for status in statuses %}<option {% if status==item.status %}selected{% endif %}>
                                        {{ status }}</option>{% endfor %}
                                </select>
                            </div>
                            <div class="col-span-2 flex items-center">
                                <input type="checkbox" id="is_essential_{{item.id}}"
                                    onchange="updateItem({{ item.id }}, 'is_essential', this.checked)"
                                    class="h-4 w-4 text-blue-600 border-gray-300 rounded focus:ring-blue-500" {% if
                                    item.is_essential %}checked{% endif %}>
                                <label for="is_essential_{{item.id}}"
                                    class="ml-2 font-semibold text-gray-600 dark:text-gray-300">Is Essential?</label>
                            </div>
                        </div>
                    </div>
                    {% endfor %}
                </div>
            </div>
        </div>
        {% endfor %}
        {% else %}
        <div class="text-center py-10 bg-white dark:bg-gray-800 rounded-xl shadow-lg">
            <p class="text-gray-500 dark:text-gray-400">No grocery items found. Add one to get started!</p>
        </div>
        {% endif %}
    </div>
    <div id="no-results" class="text-center py-10 text-gray-500 dark:text-gray-400 hidden">No items match your search.
    </div>
</div>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Auto-hide toast messages
        const toastContainer = document.getElementById('toast-container');
        if (toastContainer) {
            setTimeout(() => {
                toastContainer.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        // Household Switcher
        document.getElementById('householdSwitcher').addEventListener('change', function () {
            window.location.href = '/household/' + this.value;
        });

        // Desktop Dropdown Toggle
        const menuButton = document.getElementById('menu-button');
        const dropdownMenu = document.getElementById('dropdown-menu');
        if (menuButton) {
            menuButton.addEventListener('click', () => {
                dropdownMenu.classList.toggle('hidden');
            });
            document.addEventListener('click', (event) => {
                if (!menuButton.contains(event.target) && !dropdownMenu.contains(event.target)) {
                    dropdownMenu.classList.add('hidden');
                }
            });
        }

        // Mobile Menu Toggle
        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');
        if (mobileMenuButton) {
            mobileMenuButton.addEventListener('click', () => {
                mobileMenu.classList.toggle('hidden');
            });
            document.addEventListener('click', (event) => {
                if (!mobileMenuButton.contains(event.target) && !mobileMenu.contains(event.target)) {
                    mobileMenu.classList.add('hidden');
                }
            });
        }

        // Accordion functionality
        const accordionHeaders = document.querySelectorAll('.accordion-header');
        accordionHeaders.forEach(header => {
            header.addEventListener('click', () => {
                const content = header.nextElementSibling;
                const icon = header.querySelector('.accordion-icon');

                content.classList.toggle('hidden');
                icon.classList.toggle('rotate-180');
            });
        });

        // Search functionality
        const searchInput = document.getElementById('searchInput');
        const desktopItemList = document.querySelector('.hidden.sm\\:block');
        const mobileItemList = document.getElementById('mobile-item-list');
        const noResultsMessage = document.getElementById('no-results');

        function filterItems() {
            const searchTerm = searchInput.value.toLowerCase();
            let anyItemFound = false;

            const desktopRows = desktopItemList.querySelectorAll('.grocery-item');
            desktopRows.forEach(row => {
                const itemName = row.querySelector('.item-name').textContent.toLowerCase();
                if (itemName.includes(searchTerm)) {
                    row.style.display = '';
                    anyItemFound = true;
                } else {
                    row.style.display = 'none';
                }
            });

            const accordionContainers = mobileItemList.querySelectorAll('.accordion-container');
            accordionContainers.forEach(container => {
                const itemsInCategory = container.querySelectorAll('.grocery-item');
                let categoryHasVisibleItem = false;

                itemsInCategory.forEach(item => {
                    const itemName = item.querySelector('.item-name').textContent.toLowerCase();
                    if (itemName.includes(searchTerm)) {
                        item.style.display = '';
                        categoryHasVisibleItem = true;
                        anyItemFound = true;
                    } else {
                        item.style.display = 'none';
                    }
                });

                if (categoryHasVisibleItem) {
                    container.style.display = '';
                } else {
                    container.style.display = 'none';
                }
            });

            noResultsMessage.style.display = anyItemFound ? 'none' : 'block';
        }

        if (searchInput) {
            searchInput.addEventListener('keyup', filterItems);
            searchInput.addEventListener('search', filterItems);
        }

        // Inline Update Function
        window.updateItem = function (itemId, field, value) {
            fetch(`/household/{{ household_id }}/update_item/${itemId}`, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    field: field,
                    value: value
                })
            })
                .then(response => response.json())
                .then(data => {
                    if (!data.success) {
                        alert('Error updating item: ' + data.message);
                    }
                    // Optionally, show a success toast here
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('An unexpected error occurred.');
                });
        }
    });
</script>
{% endblock %}